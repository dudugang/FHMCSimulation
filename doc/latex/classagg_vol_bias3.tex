\hypertarget{classagg_vol_bias3}{\section{agg\-Vol\-Bias3 Class Reference}
\label{classagg_vol_bias3}\index{agg\-Vol\-Bias3@{agg\-Vol\-Bias3}}
}


{\ttfamily \#include $<$aggvolbias.\-h$>$}

Inheritance diagram for agg\-Vol\-Bias3\-:\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[height=2.000000cm]{classagg_vol_bias3}
\end{center}
\end{figure}
\subsection*{Public Member Functions}
\begin{DoxyCompactItemize}
\item 
\hyperlink{classagg_vol_bias3_a6fd174822857506eb4c61833ba6697ef}{agg\-Vol\-Bias3} ()
\item 
\hyperlink{classagg_vol_bias3_ac6a23cf87ba65eb6dba8f6512f0d7c78}{agg\-Vol\-Bias3} (const int type\-Index, const int type\-Index2, const double p\-Bias, const std\-::vector$<$ double $>$ rc1, const std\-::vector$<$ double $>$ rc2, const std\-::string tag)
\begin{DoxyCompactList}\small\item\em Instantiate a canonical aggregation-\/volume bias move to swap particles. \end{DoxyCompactList}\item 
int \hyperlink{classagg_vol_bias3_a59ebf724c8af1921045710fe9a08dd01}{make} (\hyperlink{classsim_system}{sim\-System} \&sys)
\begin{DoxyCompactList}\small\item\em Use aggregation-\/volume bias to swap two particles in the system. \end{DoxyCompactList}\end{DoxyCompactItemize}
\subsection*{Additional Inherited Members}


\subsection{Detailed Description}


Definition at line 11 of file aggvolbias.\-h.



\subsection{Constructor \& Destructor Documentation}
\hypertarget{classagg_vol_bias3_a6fd174822857506eb4c61833ba6697ef}{\index{agg\-Vol\-Bias3@{agg\-Vol\-Bias3}!agg\-Vol\-Bias3@{agg\-Vol\-Bias3}}
\index{agg\-Vol\-Bias3@{agg\-Vol\-Bias3}!aggVolBias3@{agg\-Vol\-Bias3}}
\subsubsection[{agg\-Vol\-Bias3}]{\setlength{\rightskip}{0pt plus 5cm}agg\-Vol\-Bias3\-::agg\-Vol\-Bias3 (
\begin{DoxyParamCaption}
{}
\end{DoxyParamCaption}
)\hspace{0.3cm}{\ttfamily [inline]}}}\label{classagg_vol_bias3_a6fd174822857506eb4c61833ba6697ef}


Definition at line 13 of file aggvolbias.\-h.



References mc\-Move\-::change\-N\-\_\-.


\begin{DoxyCode}
13 \{ \hyperlink{classmc_move_add8d6d08be181274a61c7463159ad929}{changeN\_} = \textcolor{keyword}{false}; pBias\_ = 0; \}
\end{DoxyCode}
\hypertarget{classagg_vol_bias3_ac6a23cf87ba65eb6dba8f6512f0d7c78}{\index{agg\-Vol\-Bias3@{agg\-Vol\-Bias3}!agg\-Vol\-Bias3@{agg\-Vol\-Bias3}}
\index{agg\-Vol\-Bias3@{agg\-Vol\-Bias3}!aggVolBias3@{agg\-Vol\-Bias3}}
\subsubsection[{agg\-Vol\-Bias3}]{\setlength{\rightskip}{0pt plus 5cm}agg\-Vol\-Bias3\-::agg\-Vol\-Bias3 (
\begin{DoxyParamCaption}
\item[{const int}]{type\-Index, }
\item[{const int}]{type\-Index2, }
\item[{const double}]{p\-Bias, }
\item[{const std\-::vector$<$ double $>$}]{rc1, }
\item[{const std\-::vector$<$ double $>$}]{rc2, }
\item[{const std\-::string}]{tag}
\end{DoxyParamCaption}
)}}\label{classagg_vol_bias3_ac6a23cf87ba65eb6dba8f6512f0d7c78}


Instantiate a canonical aggregation-\/volume bias move to swap particles. 

A\-V\-B\-M\-C3 from Chen and Siepmann, J. Phys. Chem. B 105 (2001).


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em type\-Index} & Type to consider in swapping in the vicinity of \\
\hline
\mbox{\tt in}  & {\em type\-Index2} & Second type to consider in swapping in the vicinity of \\
\hline
\mbox{\tt in}  & {\em p\-Bias} & Biasing probability \\
\hline
\mbox{\tt in}  & {\em rc1} & Radius (min, max) around particle of type\-Index to consider as being the \char`\"{}in\char`\"{} region \\
\hline
\mbox{\tt in}  & {\em rc2} & Radius (min, max) around particle of type\-Index2 to consider as being the \char`\"{}in\char`\"{} region \\
\hline
\mbox{\tt in}  & {\em tag} & Name modifier to identify move to user \\
\hline
\end{DoxyParams}


Definition at line 99 of file aggvolbias.\-cpp.



References mc\-Move\-::change\-N\-\_\-, mc\-Move\-::name\-\_\-, and mc\-Move\-::type\-Index\-\_\-.


\begin{DoxyCode}
99                                                                                                            
                                                                       \{
100     \hyperlink{classmc_move_acb731965547b0326ef318ec96da8b46a}{typeIndex\_} = typeIndex;
101     typeIndex2\_ = typeIndex2;
102 
103     \textcolor{keywordflow}{if} (pBias < 1 && pBias > 0) \{
104         pBias\_ = pBias;
105     \} \textcolor{keywordflow}{else} \{
106         \textcolor{keywordflow}{throw} \hyperlink{classcustom_exception}{customException} (\textcolor{stringliteral}{"Bias probability must be > 0 and < 1 for aggVolBias"});
107     \}
108 
109     \textcolor{keywordflow}{if} (!(rc1[0] > 0.0)) \{
110             \textcolor{keywordflow}{throw} \hyperlink{classcustom_exception}{customException} (\textcolor{stringliteral}{"Neighborhood radius for species 1 in aggVolBias must be
       > 0"});
111         \} \textcolor{keywordflow}{else} \{
112             rc1min\_ = rc1[0];
113         \}
114         \textcolor{keywordflow}{if} (!(rc2[0] > 0.0)) \{
115             \textcolor{keywordflow}{throw} \hyperlink{classcustom_exception}{customException} (\textcolor{stringliteral}{"Neighborhood radius for species 2 in aggVolBias must be
       > 0"});
116         \} \textcolor{keywordflow}{else} \{
117             rc2min\_ = rc2[0];
118         \}
119 
120     \textcolor{keywordflow}{if} (!(rc1[1] > rc1[0])) \{
121                 \textcolor{keywordflow}{throw} \hyperlink{classcustom_exception}{customException} (\textcolor{stringliteral}{"Max neighborhood radius for species 1 in aggVolBias
       must be > min"});
122         \} \textcolor{keywordflow}{else} \{
123                 rc1max\_ = rc1[1];
124         \}
125         \textcolor{keywordflow}{if} (!(rc2[1] > rc2[0])) \{
126                 \textcolor{keywordflow}{throw} \hyperlink{classcustom_exception}{customException} (\textcolor{stringliteral}{"Max neighborhood radius for species 2 in aggVolBias
       must be > min"});
127         \} \textcolor{keywordflow}{else} \{
128                 rc2max\_ = rc2[1];
129         \}
130 
131         \hyperlink{classmc_move_ac18c307855e1cb5751bd6e079857a8c5}{name\_} = tag + std::to\_string(typeIndex) + \textcolor{stringliteral}{"\_"} + std::to\_string(typeIndex2);
132     \hyperlink{classmc_move_add8d6d08be181274a61c7463159ad929}{changeN\_} = \textcolor{keyword}{false};
133 \}
\end{DoxyCode}


\subsection{Member Function Documentation}
\hypertarget{classagg_vol_bias3_a59ebf724c8af1921045710fe9a08dd01}{\index{agg\-Vol\-Bias3@{agg\-Vol\-Bias3}!make@{make}}
\index{make@{make}!aggVolBias3@{agg\-Vol\-Bias3}}
\subsubsection[{make}]{\setlength{\rightskip}{0pt plus 5cm}int agg\-Vol\-Bias3\-::make (
\begin{DoxyParamCaption}
\item[{{\bf sim\-System} \&}]{sys}
\end{DoxyParamCaption}
)\hspace{0.3cm}{\ttfamily [virtual]}}}\label{classagg_vol_bias3_a59ebf724c8af1921045710fe9a08dd01}


Use aggregation-\/volume bias to swap two particles in the system. 

All other information is stored in the \hyperlink{classsim_system}{sim\-System} object.


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em sys} & System object to attempt to swap particles in.\\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
M\-O\-V\-E\-\_\-\-S\-U\-C\-C\-E\-S\-S if particles are swapped, otherwise M\-O\-V\-E\-\_\-\-F\-A\-I\-L\-U\-R\-E if not. Will throw exceptions if there was an error. 
\end{DoxyReturn}


Implements \hyperlink{classmc_move_a2e377a628f9ecee5422fc8967d4924eb}{mc\-Move}.



Definition at line 142 of file aggvolbias.\-cpp.



References sim\-System\-::atoms, sim\-System\-::beta(), sim\-System\-::box(), calculate\-Bias(), sim\-System\-::get\-Current\-M(), sim\-System\-::get\-Fractional\-Atom\-Type(), sim\-System\-::get\-Tot\-N(), sim\-System\-::get\-W\-A\-L\-A\-Bias(), sim\-System\-::increment\-Energy(), M\-O\-V\-E\-\_\-\-F\-A\-I\-L\-U\-R\-E, M\-O\-V\-E\-\_\-\-S\-U\-C\-C\-E\-S\-S, sim\-System\-::n\-Species(), sim\-System\-::num\-Species, pbc\-Dist2(), P\-I, atom\-::pos, random3\-D\-Surface\-Vector(), rng(), R\-N\-G\-\_\-\-S\-E\-E\-D, sim\-System\-::tmmc\-Bias, sim\-System\-::translate\-Atom(), mc\-Move\-::type\-Index\-\_\-, wala\-::update(), tmmc\-::update\-C(), sim\-System\-::use\-T\-M\-M\-C, sim\-System\-::use\-W\-A\-L\-A, and custom\-Exception\-::what().


\begin{DoxyCode}
142                                      \{
143         \textcolor{comment}{// choose a particle of typeIndex\_}
144         \textcolor{keywordtype}{int} nAvail1 = sys.\hyperlink{classsim_system_a9eea865e6dc1cff377b1e79c4d9c23f0}{numSpecies}[\hyperlink{classmc_move_acb731965547b0326ef318ec96da8b46a}{typeIndex\_}];
145         \textcolor{keywordflow}{if} (sys.\hyperlink{classsim_system_a299fe4372e610b554eaaf5f5957b2dbc}{getCurrentM}() > 0 && sys.\hyperlink{classsim_system_a0500a9e84eecfbde7a98cf8a34f719d5}{getFractionalAtomType}() == 
      \hyperlink{classmc_move_acb731965547b0326ef318ec96da8b46a}{typeIndex\_}) \{
146             nAvail1++;
147         \}
148 
149         \textcolor{comment}{// choose a particle of typeIndex2\_}
150         \textcolor{keywordtype}{int} nAvail2 = sys.\hyperlink{classsim_system_a9eea865e6dc1cff377b1e79c4d9c23f0}{numSpecies}[typeIndex2\_];
151         \textcolor{keywordflow}{if} (sys.\hyperlink{classsim_system_a299fe4372e610b554eaaf5f5957b2dbc}{getCurrentM}() > 0 && sys.\hyperlink{classsim_system_a0500a9e84eecfbde7a98cf8a34f719d5}{getFractionalAtomType}() == 
      typeIndex2\_) \{
152             nAvail2++;
153         \}
154 
155         \textcolor{comment}{// update biases even upon failure to try move (also reject if types are same and only one overall
       particle)}
156         \textcolor{keywordflow}{if} (nAvail1 < 1 || nAvail2 < 1 || (\hyperlink{classmc_move_acb731965547b0326ef318ec96da8b46a}{typeIndex\_} == typeIndex2\_ && nAvail1 <= 1)) \{
157             \textcolor{keywordflow}{if} (sys.\hyperlink{classsim_system_aa83b00006b3919fb6e13f1bdeadece6a}{useWALA}) \{
158                     sys.\hyperlink{classsim_system_a7cb5049de8b0988349e89e30e4000407}{getWALABias}()->\hyperlink{classwala_ab439e3f60bea6c54522a870b9ad67acf}{update}(sys.\hyperlink{classsim_system_a37dd827f4057049763351510147b9f1d}{getTotN}(), sys.
      \hyperlink{classsim_system_a299fe4372e610b554eaaf5f5957b2dbc}{getCurrentM}());
159             \}
160             \textcolor{keywordflow}{if} (sys.\hyperlink{classsim_system_aa474a50b6353c8897331b1ab1ce53ab1}{useTMMC}) \{
161                     sys.\hyperlink{classsim_system_a13173f45a1e40a5f5a3552b0ebe15b54}{tmmcBias}->\hyperlink{classtmmc_ae067afc5b52af203b9d45f18d9737219}{updateC} (sys.\hyperlink{classsim_system_a37dd827f4057049763351510147b9f1d}{getTotN}(), sys.
      \hyperlink{classsim_system_a37dd827f4057049763351510147b9f1d}{getTotN}(), sys.\hyperlink{classsim_system_a299fe4372e610b554eaaf5f5957b2dbc}{getCurrentM}(), sys.\hyperlink{classsim_system_a299fe4372e610b554eaaf5f5957b2dbc}{getCurrentM}(), 0.0);
162             \}
163             \textcolor{keywordflow}{return} \hyperlink{moves_8h_a9832cf5fcfa8c0894545b591c9908e39}{MOVE\_FAILURE};
164         \}
165 
166         \textcolor{comment}{// choose particles, j and k - at present we are guaranteed at least 2 unique particles in the
       system}
167         \textcolor{keywordtype}{int} pkJ = (int) floor(\hyperlink{utilities_8cpp_a0f9542af4b475ac79cb679d7a8d14db0}{rng} (&\hyperlink{global_8h_a3f4e4ea24d5a5c66feae55d1f329c884}{RNG\_SEED}) * nAvail1), pkK = 0, iterMax = 25, iter = 0;
168         \textcolor{keywordtype}{bool} jkOverlap = \textcolor{keyword}{true};
169         \textcolor{keywordflow}{while} (jkOverlap && iter < iterMax) \{
170             \textcolor{comment}{// if there are only a few particles in the system, they may all overlap so reject after a
       number of trials}
171             iter++;
172 
173             pkK = (int) floor(\hyperlink{utilities_8cpp_a0f9542af4b475ac79cb679d7a8d14db0}{rng} (&\hyperlink{global_8h_a3f4e4ea24d5a5c66feae55d1f329c884}{RNG\_SEED}) * nAvail2);
174 
175             \textcolor{comment}{// establish if j and k overlap their "in" regions}
176             \textcolor{keyword}{const} \textcolor{keywordtype}{double} rc = (rc1max\_ + rc2max\_)/2.0;
177 
178             \textcolor{comment}{// if pkK and pkJ are withing rcut of each other, they overlap}
179             \textcolor{keywordflow}{if} (\hyperlink{utilities_8cpp_abb1db3a8a3ac46e044bbe7b2c5684c0a}{pbcDist2}(sys.\hyperlink{classsim_system_a90421b19082f7fb8fc23b7264b1161e4}{atoms}[\hyperlink{classmc_move_acb731965547b0326ef318ec96da8b46a}{typeIndex\_}][pkJ].pos, sys.
      \hyperlink{classsim_system_a90421b19082f7fb8fc23b7264b1161e4}{atoms}[typeIndex2\_][pkK].pos, sys.\hyperlink{classsim_system_a8bff9dfb95b1b09a0fab2c1c485ade07}{box}()) > rc*rc) \{
180                     jkOverlap = \textcolor{keyword}{false};
181             \}
182 
183             \textcolor{comment}{// However, we also technically need to ensure that if typeIndex\_ == typeIndex2\_, j and k are
       not the same particle.}
184             \textcolor{comment}{// Happily, this is already guaranteed by the above distance check (a particle is a distance 0
       from itself)}
185         \}
186 
187         \textcolor{comment}{// check for failure to find pkJ and pkK}
188         \textcolor{keywordflow}{if} (iter >= iterMax) \{
189             \textcolor{keywordflow}{if} (sys.\hyperlink{classsim_system_aa83b00006b3919fb6e13f1bdeadece6a}{useWALA}) \{
190                     sys.\hyperlink{classsim_system_a7cb5049de8b0988349e89e30e4000407}{getWALABias}()->\hyperlink{classwala_ab439e3f60bea6c54522a870b9ad67acf}{update}(sys.\hyperlink{classsim_system_a37dd827f4057049763351510147b9f1d}{getTotN}(), sys.
      \hyperlink{classsim_system_a299fe4372e610b554eaaf5f5957b2dbc}{getCurrentM}());
191             \}
192             \textcolor{keywordflow}{if} (sys.\hyperlink{classsim_system_aa474a50b6353c8897331b1ab1ce53ab1}{useTMMC}) \{
193                     sys.\hyperlink{classsim_system_a13173f45a1e40a5f5a3552b0ebe15b54}{tmmcBias}->\hyperlink{classtmmc_ae067afc5b52af203b9d45f18d9737219}{updateC} (sys.\hyperlink{classsim_system_a37dd827f4057049763351510147b9f1d}{getTotN}(), sys.
      \hyperlink{classsim_system_a37dd827f4057049763351510147b9f1d}{getTotN}(), sys.\hyperlink{classsim_system_a299fe4372e610b554eaaf5f5957b2dbc}{getCurrentM}(), sys.\hyperlink{classsim_system_a299fe4372e610b554eaaf5f5957b2dbc}{getCurrentM}(), 0.0);
194             \}
195             \textcolor{keywordflow}{return} \hyperlink{moves_8h_a9832cf5fcfa8c0894545b591c9908e39}{MOVE\_FAILURE};
196         \}
197 
198         \textcolor{keyword}{const} std::vector < double > box = sys.\hyperlink{classsim_system_a8bff9dfb95b1b09a0fab2c1c485ade07}{box}();
199         \textcolor{keywordtype}{double} minL = box[0];
200         \textcolor{keywordtype}{double} V = 1.0;
201         \textcolor{keywordflow}{for} (\textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{int} i = 0; i < box.size(); ++i) \{
202             V *= box[i];
203             minL = std::min(minL, box[i]);
204         \}
205 
206         \textcolor{comment}{// sanity check for rc's}
207         \textcolor{keywordflow}{if} (!(rc1max\_ < minL/2.0)) \{
208             \textcolor{keywordflow}{throw} \hyperlink{classcustom_exception}{customException} (\textcolor{stringliteral}{"Max neighborhood radius for species 1 in aggVolBias must
       be < box/2"});
209         \}
210         \textcolor{keywordflow}{if} (!(rc2max\_ < minL/2.0)) \{
211             \textcolor{keywordflow}{throw} \hyperlink{classcustom_exception}{customException} (\textcolor{stringliteral}{"Max neighborhood radius for species 2 in aggVolBias must
       be < box/2"});
212         \}
213 
214         \textcolor{comment}{// based on the choices made below, the unbiased acceptance probability will be set in each case}
215         \textcolor{keywordtype}{double} p\_u = 1.0, bias = 1.0, dU = 0.0;
216     \textcolor{keywordtype}{double} V\_in\_j = 0.0, V\_in\_k = 0.0, V\_out\_j = 0.0, V\_out\_k = 0.0;
217         \textcolor{keywordtype}{int} chosenAtomType = 0;
218     \textcolor{keywordtype}{int}  N\_in\_k = 0, N\_in\_j = 0, N\_out\_k = 0, N\_out\_j = 0;
219         \hyperlink{classatom}{atom}* chosenAtom;
220         \hyperlink{classatom}{atom} tmpNewAtom; \textcolor{comment}{// stores position the chosenAtom is being proposed to be moved to}
221         \textcolor{keywordtype}{bool} inA = \textcolor{keyword}{false}; \textcolor{comment}{// is this a "in" to X move?}
222 
223         \textcolor{keywordflow}{if} (\hyperlink{utilities_8cpp_a0f9542af4b475ac79cb679d7a8d14db0}{rng}(&\hyperlink{global_8h_a3f4e4ea24d5a5c66feae55d1f329c884}{RNG\_SEED}) < pBias\_) \{
224             \textcolor{comment}{// choose a particle either "in" k or "out" j with equal probability}
225             \textcolor{comment}{// note that "out" j includes the "in" k region as well}
226             \textcolor{keywordflow}{if} (\hyperlink{utilities_8cpp_a0f9542af4b475ac79cb679d7a8d14db0}{rng} (&\hyperlink{global_8h_a3f4e4ea24d5a5c66feae55d1f329c884}{RNG\_SEED}) < 0.5) \{
227                     \textcolor{comment}{// choose particle "in" k, this chosen particle can be of any type}
228                     inA = \textcolor{keyword}{true};
229             std::vector < atom* > neighborAtoms;
230                     neighborAtoms.reserve(100); \textcolor{comment}{// 100 is just an arbitrary number to help accelerate}
231                     std::vector < int > nEachType (sys.\hyperlink{classsim_system_ab5e2e9b6204de15520302fe1d51688dd}{nSpecies}(), 0);
232                     \textcolor{keywordflow}{for} (\textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{int} i = 0; i < sys.\hyperlink{classsim_system_ab5e2e9b6204de15520302fe1d51688dd}{nSpecies}(); ++i) \{
233                         \textcolor{keywordtype}{int} totKatoms = sys.\hyperlink{classsim_system_a9eea865e6dc1cff377b1e79c4d9c23f0}{numSpecies}[i];
234 
235                         \textcolor{comment}{// account for if in expanded ensemble and have an additional partially inserted
       particle floating around}
236                         \textcolor{keywordflow}{if} (sys.\hyperlink{classsim_system_a299fe4372e610b554eaaf5f5957b2dbc}{getCurrentM}() > 0 && sys.
      \hyperlink{classsim_system_a0500a9e84eecfbde7a98cf8a34f719d5}{getFractionalAtomType}() == i) \{
237                                 totKatoms++;
238                         \}
239 
240                         \textcolor{keywordflow}{for} (\textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{int} j = 0; j < totKatoms; ++j) \{
241                     \textcolor{keyword}{const} \textcolor{keywordtype}{double} d2 = \hyperlink{utilities_8cpp_abb1db3a8a3ac46e044bbe7b2c5684c0a}{pbcDist2}(sys.\hyperlink{classsim_system_a90421b19082f7fb8fc23b7264b1161e4}{atoms}[i][j].pos, sys.
      \hyperlink{classsim_system_a90421b19082f7fb8fc23b7264b1161e4}{atoms}[typeIndex2\_][pkK].pos, sys.\hyperlink{classsim_system_a8bff9dfb95b1b09a0fab2c1c485ade07}{box}());
242                                 \textcolor{keywordflow}{if} (d2 < rc2max\_*rc2max\_ && d2 >= rc2min\_*rc2min\_) \{
243                                     \textcolor{keywordflow}{if} (&sys.\hyperlink{classsim_system_a90421b19082f7fb8fc23b7264b1161e4}{atoms}[typeIndex2\_][pkK] != &sys.
      \hyperlink{classsim_system_a90421b19082f7fb8fc23b7264b1161e4}{atoms}[i][j]) \{ \textcolor{comment}{// since J and K do not overlap do not have to check if this is pkJ}
244                                             neighborAtoms.push\_back(&sys.\hyperlink{classsim_system_a90421b19082f7fb8fc23b7264b1161e4}{atoms}[i][j]);
245                                             nEachType[i] += 1;
246                                     \}
247                                 \}
248                         \}
249                     \}
250 
251                     \textcolor{comment}{// reject move if no neighbors}
252                     \textcolor{keywordflow}{if} (neighborAtoms.begin() == neighborAtoms.end()) \{
253                         \textcolor{keywordflow}{if} (sys.\hyperlink{classsim_system_aa83b00006b3919fb6e13f1bdeadece6a}{useWALA}) \{
254                                 sys.\hyperlink{classsim_system_a7cb5049de8b0988349e89e30e4000407}{getWALABias}()->\hyperlink{classwala_ab439e3f60bea6c54522a870b9ad67acf}{update}(sys.
      \hyperlink{classsim_system_a37dd827f4057049763351510147b9f1d}{getTotN}(), sys.\hyperlink{classsim_system_a299fe4372e610b554eaaf5f5957b2dbc}{getCurrentM}());
255                         \}
256                         \textcolor{keywordflow}{if} (sys.\hyperlink{classsim_system_aa474a50b6353c8897331b1ab1ce53ab1}{useTMMC}) \{
257                                 sys.\hyperlink{classsim_system_a13173f45a1e40a5f5a3552b0ebe15b54}{tmmcBias}->\hyperlink{classtmmc_ae067afc5b52af203b9d45f18d9737219}{updateC} (sys.
      \hyperlink{classsim_system_a37dd827f4057049763351510147b9f1d}{getTotN}(), sys.\hyperlink{classsim_system_a37dd827f4057049763351510147b9f1d}{getTotN}(), sys.\hyperlink{classsim_system_a299fe4372e610b554eaaf5f5957b2dbc}{getCurrentM}(), sys.
      \hyperlink{classsim_system_a299fe4372e610b554eaaf5f5957b2dbc}{getCurrentM}(), 0.0);
258                         \}
259                         \textcolor{keywordflow}{return} \hyperlink{moves_8h_a9832cf5fcfa8c0894545b591c9908e39}{MOVE\_FAILURE};
260                     \}
261 
262                     \textcolor{comment}{// otherwise choose an atom}
263                     \textcolor{keyword}{const} \textcolor{keywordtype}{int} atomIndex = (int) floor(\hyperlink{utilities_8cpp_a0f9542af4b475ac79cb679d7a8d14db0}{rng} (&\hyperlink{global_8h_a3f4e4ea24d5a5c66feae55d1f329c884}{RNG\_SEED}) * neighborAtoms.size());
264                     chosenAtom = neighborAtoms[atomIndex];
265                 \textcolor{keywordtype}{int} tot = 0;
266                     \textcolor{keywordflow}{while} (tot < atomIndex) \{
267                         tot += nEachType[chosenAtomType];
268                         chosenAtomType++;
269                         \textcolor{keywordflow}{if} (chosenAtomType > sys.\hyperlink{classsim_system_ab5e2e9b6204de15520302fe1d51688dd}{nSpecies}()) \{ \textcolor{comment}{// > not >= because chosenAtomType
       will be decremented next}
270                                 \textcolor{keywordflow}{throw} \hyperlink{classcustom_exception}{customException} (\textcolor{stringliteral}{"Error, could not properly identify
       the type of the atom chosen to be moved in aggVolBias"});
271                         \}
272                     \}
273                     chosenAtomType--;
274                     \textcolor{keywordflow}{if} (chosenAtomType < 0) \{ \textcolor{comment}{// in case atomIndex = 0 and above loop did not execute at
       all}
275                         chosenAtomType = 0;
276                     \}
277 
278             N\_in\_k = nEachType[chosenAtomType]; \textcolor{comment}{// only concerned about the number of the chosen type}
279             V\_in\_k = 4.0/3.0*\hyperlink{global_8h_a598a3330b3c21701223ee0ca14316eca}{PI}*(rc2max\_*rc2max\_*rc2max\_ - rc2min\_*rc2min\_*rc2min\_);
280         \} \textcolor{keywordflow}{else} \{
281                     \textcolor{comment}{// choose particle "out" of j, this chosen particle can be of any type}
282                     inA = \textcolor{keyword}{false};
283 
284                     \textcolor{comment}{// just pick atoms (of any type) at random and see if it is "out" of j}
285                     \textcolor{comment}{// this should be faster than establishing, a priori, all atoms which are "out"}
286                     \textcolor{comment}{// and then picking from that list since *most* atoms should be "out"}
287                     \textcolor{comment}{// unlike when we have to pick from "in" ones which are more rare}
288 
289             \textcolor{keywordtype}{int} iter = 0, iterMax = 25;
290                     \textcolor{keywordtype}{bool} inJ = \textcolor{keyword}{true};
291 
292             \textcolor{keywordflow}{while} (inJ && iter < iterMax) \{
293                         iter++;
294                         \textcolor{keyword}{const} \textcolor{keywordtype}{int} ranSpec = (int) floor(\hyperlink{utilities_8cpp_a0f9542af4b475ac79cb679d7a8d14db0}{rng} (&\hyperlink{global_8h_a3f4e4ea24d5a5c66feae55d1f329c884}{RNG\_SEED}) * sys.
      \hyperlink{classsim_system_ab5e2e9b6204de15520302fe1d51688dd}{nSpecies}());
295                         \textcolor{keywordtype}{int} availAtoms = sys.\hyperlink{classsim_system_a9eea865e6dc1cff377b1e79c4d9c23f0}{numSpecies}[ranSpec];
296                         \textcolor{comment}{// account for if in expanded ensemble and have an additional partially inserted
       particle floating around}
297                         \textcolor{keywordflow}{if} (sys.\hyperlink{classsim_system_a299fe4372e610b554eaaf5f5957b2dbc}{getCurrentM}() > 0 && sys.
      \hyperlink{classsim_system_a0500a9e84eecfbde7a98cf8a34f719d5}{getFractionalAtomType}() == ranSpec) \{
298                             availAtoms++;
299                         \}
300                         \textcolor{keywordtype}{int} ranIndex = (int) floor(\hyperlink{utilities_8cpp_a0f9542af4b475ac79cb679d7a8d14db0}{rng} (&\hyperlink{global_8h_a3f4e4ea24d5a5c66feae55d1f329c884}{RNG\_SEED}) * availAtoms);
301 
302                         \textcolor{comment}{// check this atom is neither pkJ nor pkK}
303                         \textcolor{keywordflow}{if} (&sys.\hyperlink{classsim_system_a90421b19082f7fb8fc23b7264b1161e4}{atoms}[ranSpec][ranIndex] != &sys.\hyperlink{classsim_system_a90421b19082f7fb8fc23b7264b1161e4}{atoms}[
      \hyperlink{classmc_move_acb731965547b0326ef318ec96da8b46a}{typeIndex\_}][pkJ] && &sys.\hyperlink{classsim_system_a90421b19082f7fb8fc23b7264b1161e4}{atoms}[ranSpec][ranIndex] != &sys.\hyperlink{classsim_system_a90421b19082f7fb8fc23b7264b1161e4}{atoms}[typeIndex2\_][pkK]) \{
304                             \textcolor{keyword}{const} \textcolor{keywordtype}{double} d2 = \hyperlink{utilities_8cpp_abb1db3a8a3ac46e044bbe7b2c5684c0a}{pbcDist2}(sys.\hyperlink{classsim_system_a90421b19082f7fb8fc23b7264b1161e4}{atoms}[ranSpec][ranIndex].pos, sys.
      \hyperlink{classsim_system_a90421b19082f7fb8fc23b7264b1161e4}{atoms}[\hyperlink{classmc_move_acb731965547b0326ef318ec96da8b46a}{typeIndex\_}][pkJ].pos, sys.\hyperlink{classsim_system_a8bff9dfb95b1b09a0fab2c1c485ade07}{box}());
305                     \textcolor{keywordflow}{if} (!(d2 < rc1max\_*rc1max\_ && d2 >= rc1min\_*rc1min\_)) \{
306                                     chosenAtom = &sys.\hyperlink{classsim_system_a90421b19082f7fb8fc23b7264b1161e4}{atoms}[ranSpec][ranIndex];
307                                     chosenAtomType = ranSpec;
308                                     inJ = \textcolor{keyword}{false};
309                                 \}
310                         \}
311                     \}
312 
313                     \textcolor{comment}{// check if we could not locate a particle "out" of j}
314                     \textcolor{keywordflow}{if} (iter >= iterMax) \{
315                         \textcolor{keywordflow}{if} (sys.\hyperlink{classsim_system_aa83b00006b3919fb6e13f1bdeadece6a}{useWALA}) \{
316                                 sys.\hyperlink{classsim_system_a7cb5049de8b0988349e89e30e4000407}{getWALABias}()->\hyperlink{classwala_ab439e3f60bea6c54522a870b9ad67acf}{update}(sys.
      \hyperlink{classsim_system_a37dd827f4057049763351510147b9f1d}{getTotN}(), sys.\hyperlink{classsim_system_a299fe4372e610b554eaaf5f5957b2dbc}{getCurrentM}());
317                         \}
318                         \textcolor{keywordflow}{if} (sys.\hyperlink{classsim_system_aa474a50b6353c8897331b1ab1ce53ab1}{useTMMC}) \{
319                                 sys.\hyperlink{classsim_system_a13173f45a1e40a5f5a3552b0ebe15b54}{tmmcBias}->\hyperlink{classtmmc_ae067afc5b52af203b9d45f18d9737219}{updateC} (sys.
      \hyperlink{classsim_system_a37dd827f4057049763351510147b9f1d}{getTotN}(), sys.\hyperlink{classsim_system_a37dd827f4057049763351510147b9f1d}{getTotN}(), sys.\hyperlink{classsim_system_a299fe4372e610b554eaaf5f5957b2dbc}{getCurrentM}(), sys.
      \hyperlink{classsim_system_a299fe4372e610b554eaaf5f5957b2dbc}{getCurrentM}(), 0.0);
320                         \}
321                         \textcolor{keywordflow}{return} \hyperlink{moves_8h_a9832cf5fcfa8c0894545b591c9908e39}{MOVE\_FAILURE};
322                     \}
323 
324             \textcolor{comment}{// need to know how many chosenAtoms are "out" of j}
325             \textcolor{keywordtype}{int} totJatoms = sys.\hyperlink{classsim_system_a9eea865e6dc1cff377b1e79c4d9c23f0}{numSpecies}[chosenAtomType];
326 
327                 \textcolor{comment}{// account for if in expanded ensemble and have an additional partially inserted particle
       floating around}
328                 \textcolor{keywordflow}{if} (sys.\hyperlink{classsim_system_a299fe4372e610b554eaaf5f5957b2dbc}{getCurrentM}() > 0 && sys.
      \hyperlink{classsim_system_a0500a9e84eecfbde7a98cf8a34f719d5}{getFractionalAtomType}() == chosenAtomType) \{
329                         totJatoms++;
330                 \}
331 
332             \textcolor{comment}{// need for V\_out\_j later}
333             V\_in\_k = 4.0/3.0*\hyperlink{global_8h_a598a3330b3c21701223ee0ca14316eca}{PI}*(rc2max\_*rc2max\_*rc2max\_ - rc2min\_*rc2min\_*rc2min\_);
334             \}
335 
336             \textcolor{comment}{// move the chosenAtom "in" j}
337 
338             \textcolor{comment}{// (1) get energy of chosenAtom in current state}
339             \textcolor{keywordtype}{double} oldEnergy = 0.0;
340             \textcolor{keywordflow}{try} \{
341                 oldEnergy = getTempEnergy\_ (sys, box, V, chosenAtomType, chosenAtom);
342             \} \textcolor{keywordflow}{catch} (\hyperlink{classcustom_exception}{customException} &ce) \{
343                     \textcolor{keywordflow}{throw} \hyperlink{classcustom_exception}{customException} (ce.\hyperlink{classcustom_exception_aeb6ab5848b038adfc68fde86a512f691}{what}());
344             \}
345 
346             \textcolor{comment}{// (2) "move" chosenAtom - randomly choose a radius from [0, rc1) around pkJ}
347             \textcolor{keyword}{const} \textcolor{keywordtype}{double} dr = (rc1max\_ - rc1min\_);
348         \textcolor{keyword}{const} \textcolor{keywordtype}{double} magnitude = pow((\hyperlink{utilities_8cpp_a0f9542af4b475ac79cb679d7a8d14db0}{rng} (&\hyperlink{global_8h_a3f4e4ea24d5a5c66feae55d1f329c884}{RNG\_SEED})*dr*dr*dr+rc1min\_*rc1min\_*rc1min\_), 1./3.);
349 
350             \textcolor{comment}{// then choose a point randomly on the surface of that sphere to place chosenAtom}
351             std::vector < double > surfaceVec = \hyperlink{utilities_8cpp_af1bc480936b7436d4e679abc5a837815}{random3DSurfaceVector} (magnitude), 
      origPos = chosenAtom->\hyperlink{classatom_a3ae5f4880e7831d8b2c9fda72b4eb24a}{pos};
352             \textcolor{keywordflow}{for} (\textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{int} i = 0; i < origPos.size(); ++i) \{
353                 chosenAtom->\hyperlink{classatom_a3ae5f4880e7831d8b2c9fda72b4eb24a}{pos}[i] = sys.\hyperlink{classsim_system_a90421b19082f7fb8fc23b7264b1161e4}{atoms}[\hyperlink{classmc_move_acb731965547b0326ef318ec96da8b46a}{typeIndex\_}][pkJ].pos[i] + surfaceVec[i];
354 
355                 \textcolor{comment}{// apply periodic boundary conditions}
356                 \textcolor{keywordflow}{if} (chosenAtom->\hyperlink{classatom_a3ae5f4880e7831d8b2c9fda72b4eb24a}{pos}[i] >= box[i]) \{
357                         chosenAtom->\hyperlink{classatom_a3ae5f4880e7831d8b2c9fda72b4eb24a}{pos}[i] -= box[i];
358                     \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (chosenAtom->\hyperlink{classatom_a3ae5f4880e7831d8b2c9fda72b4eb24a}{pos}[i] < 0) \{
359                         chosenAtom->\hyperlink{classatom_a3ae5f4880e7831d8b2c9fda72b4eb24a}{pos}[i] += box[i];
360                     \}
361             \}
362 
363             \textcolor{comment}{// store the newly proposed position for later}
364             tmpNewAtom.\hyperlink{classatom_a3ae5f4880e7831d8b2c9fda72b4eb24a}{pos} = chosenAtom->\hyperlink{classatom_a3ae5f4880e7831d8b2c9fda72b4eb24a}{pos};
365 
366         \textcolor{comment}{// establish how many chosenAtoms are "in" j}
367         \textcolor{keywordtype}{int} totJatoms = sys.\hyperlink{classsim_system_a9eea865e6dc1cff377b1e79c4d9c23f0}{numSpecies}[chosenAtomType];
368 
369             \textcolor{comment}{// account for if in expanded ensemble and have an additional partially inserted particle
       floating around}
370             \textcolor{keywordflow}{if} (sys.\hyperlink{classsim_system_a299fe4372e610b554eaaf5f5957b2dbc}{getCurrentM}() > 0 && sys.\hyperlink{classsim_system_a0500a9e84eecfbde7a98cf8a34f719d5}{getFractionalAtomType}() == 
      chosenAtomType) \{
371                 totJatoms++;
372             \}
373 
374         N\_in\_j = 0;
375             \textcolor{keywordflow}{for} (\textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{int} j = 0; j < totJatoms; ++j) \{
376                 \textcolor{keyword}{const} \textcolor{keywordtype}{double} d2 = \hyperlink{utilities_8cpp_abb1db3a8a3ac46e044bbe7b2c5684c0a}{pbcDist2}(sys.\hyperlink{classsim_system_a90421b19082f7fb8fc23b7264b1161e4}{atoms}[chosenAtomType][j].pos, sys.
      \hyperlink{classsim_system_a90421b19082f7fb8fc23b7264b1161e4}{atoms}[\hyperlink{classmc_move_acb731965547b0326ef318ec96da8b46a}{typeIndex\_}][pkJ].pos, sys.\hyperlink{classsim_system_a8bff9dfb95b1b09a0fab2c1c485ade07}{box}());
377             \textcolor{keywordflow}{if} (d2 < rc1max\_*rc1max\_ && d2 >= rc1min\_*rc1min\_) \{
378                             \textcolor{keywordflow}{if} (&sys.\hyperlink{classsim_system_a90421b19082f7fb8fc23b7264b1161e4}{atoms}[chosenAtomType][j] != &sys.\hyperlink{classsim_system_a90421b19082f7fb8fc23b7264b1161e4}{atoms}[
      \hyperlink{classmc_move_acb731965547b0326ef318ec96da8b46a}{typeIndex\_}][pkJ]) \{
379                     N\_in\_j++;
380                 \}
381             \}
382         \}
383 
384 
385         N\_out\_j = totJatoms - N\_in\_j;
386         V\_in\_j = 4.0/3.0*\hyperlink{global_8h_a598a3330b3c21701223ee0ca14316eca}{PI}*(rc1max\_*rc1max\_*rc1max\_ - rc1min\_*rc1min\_*rc1min\_);
387 
388             \textcolor{keywordtype}{double} newEnergy = 0.0;
389             \textcolor{keywordflow}{try} \{
390                 newEnergy = getTempEnergy\_ (sys, box, V, chosenAtomType, chosenAtom);
391             \} \textcolor{keywordflow}{catch} (\hyperlink{classcustom_exception}{customException} &ce) \{
392                 \textcolor{keywordflow}{throw} \hyperlink{classcustom_exception}{customException} (ce.\hyperlink{classcustom_exception_aeb6ab5848b038adfc68fde86a512f691}{what}());
393             \}
394 
395             \textcolor{comment}{// restore the atom's original state before continuing}
396             chosenAtom->\hyperlink{classatom_a3ae5f4880e7831d8b2c9fda72b4eb24a}{pos} = origPos;
397 
398             \textcolor{comment}{// assign p\_u}
399             dU = newEnergy - oldEnergy;
400             p\_u =  0.0;
401         \textcolor{keywordflow}{if} (inA) \{
402             \textcolor{comment}{// "in K" to "in J" move}
403             p\_u = (1.0 - pBias\_)*V\_in\_j*N\_in\_k*exp(-dU*sys.\hyperlink{classsim_system_a3eeec9678902f8d7fce4dad6064aaf4c}{beta}())/(pBias\_*V\_in\_k*(N\_in\_j+1.0));
404         \} \textcolor{keywordflow}{else} \{
405             \textcolor{comment}{// "out J" to "in J" move}
406             V\_out\_j = V - V\_in\_j - V\_in\_k; \textcolor{comment}{// V\_in\_k subtracted must also be done consistently}
407             p\_u = (1.0 - pBias\_)*V\_in\_j*N\_out\_j*exp(-dU*sys.\hyperlink{classsim_system_a3eeec9678902f8d7fce4dad6064aaf4c}{beta}())/((1.0 - pBias\_)*V\_out\_j*(N\_in\_j + 1
      .0));
408         \}
409     \} \textcolor{keywordflow}{else} \{
410         \textcolor{comment}{// choose a particle "in" j, this chosen particle can be of any type}
411             std::vector < atom* > neighborAtoms;
412             neighborAtoms.reserve(100); \textcolor{comment}{// 100 is just an arbitrary number to help accelerate}
413             std::vector < int > nEachType (sys.\hyperlink{classsim_system_ab5e2e9b6204de15520302fe1d51688dd}{nSpecies}(), 0);
414         \textcolor{keywordflow}{for} (\textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{int} i = 0; i < sys.\hyperlink{classsim_system_ab5e2e9b6204de15520302fe1d51688dd}{nSpecies}(); ++i) \{
415                     \textcolor{keywordtype}{int} totJatoms = sys.\hyperlink{classsim_system_a9eea865e6dc1cff377b1e79c4d9c23f0}{numSpecies}[i];
416 
417                     \textcolor{comment}{// account for if in expanded ensemble and have an additional partially inserted
       particle floating around}
418                     \textcolor{keywordflow}{if} (sys.\hyperlink{classsim_system_a299fe4372e610b554eaaf5f5957b2dbc}{getCurrentM}() > 0 && sys.
      \hyperlink{classsim_system_a0500a9e84eecfbde7a98cf8a34f719d5}{getFractionalAtomType}() == i) \{
419                         totJatoms++;
420                     \}
421 
422                     \textcolor{keywordflow}{for} (\textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{int} j = 0; j < totJatoms; ++j) \{
423                         \textcolor{keyword}{const} \textcolor{keywordtype}{double} d2 = \hyperlink{utilities_8cpp_abb1db3a8a3ac46e044bbe7b2c5684c0a}{pbcDist2}(sys.\hyperlink{classsim_system_a90421b19082f7fb8fc23b7264b1161e4}{atoms}[i][j].pos, sys.
      \hyperlink{classsim_system_a90421b19082f7fb8fc23b7264b1161e4}{atoms}[\hyperlink{classmc_move_acb731965547b0326ef318ec96da8b46a}{typeIndex\_}][pkJ].pos, sys.\hyperlink{classsim_system_a8bff9dfb95b1b09a0fab2c1c485ade07}{box}());
424                 \textcolor{keywordflow}{if} (d2 < rc1max\_*rc1max\_ && d2 >= rc1min\_*rc1min\_) \{
425                                 \textcolor{keywordflow}{if} (&sys.\hyperlink{classsim_system_a90421b19082f7fb8fc23b7264b1161e4}{atoms}[\hyperlink{classmc_move_acb731965547b0326ef318ec96da8b46a}{typeIndex\_}][pkJ] != &sys.
      \hyperlink{classsim_system_a90421b19082f7fb8fc23b7264b1161e4}{atoms}[i][j]) \{ \textcolor{comment}{// since J and K do not overlap do not have to check this is pkK}
426                                     neighborAtoms.push\_back(&sys.\hyperlink{classsim_system_a90421b19082f7fb8fc23b7264b1161e4}{atoms}[i][j]);
427                                     nEachType[i] += 1;
428                             \}
429                         \}
430                     \}
431             \}
432 
433             \textcolor{comment}{// reject move if no neighbors}
434             \textcolor{keywordflow}{if} (neighborAtoms.begin() == neighborAtoms.end()) \{
435                 \textcolor{keywordflow}{if} (sys.\hyperlink{classsim_system_aa83b00006b3919fb6e13f1bdeadece6a}{useWALA}) \{
436                         sys.\hyperlink{classsim_system_a7cb5049de8b0988349e89e30e4000407}{getWALABias}()->\hyperlink{classwala_ab439e3f60bea6c54522a870b9ad67acf}{update}(sys.\hyperlink{classsim_system_a37dd827f4057049763351510147b9f1d}{getTotN}(), sys.
      \hyperlink{classsim_system_a299fe4372e610b554eaaf5f5957b2dbc}{getCurrentM}());
437                     \}
438                     \textcolor{keywordflow}{if} (sys.\hyperlink{classsim_system_aa474a50b6353c8897331b1ab1ce53ab1}{useTMMC}) \{
439                         sys.\hyperlink{classsim_system_a13173f45a1e40a5f5a3552b0ebe15b54}{tmmcBias}->\hyperlink{classtmmc_ae067afc5b52af203b9d45f18d9737219}{updateC} (sys.\hyperlink{classsim_system_a37dd827f4057049763351510147b9f1d}{getTotN}(), sys.
      \hyperlink{classsim_system_a37dd827f4057049763351510147b9f1d}{getTotN}(), sys.\hyperlink{classsim_system_a299fe4372e610b554eaaf5f5957b2dbc}{getCurrentM}(), sys.\hyperlink{classsim_system_a299fe4372e610b554eaaf5f5957b2dbc}{getCurrentM}(), 0.0);
440                     \}
441                 \textcolor{keywordflow}{return} \hyperlink{moves_8h_a9832cf5fcfa8c0894545b591c9908e39}{MOVE\_FAILURE};
442             \}
443 
444             \textcolor{comment}{// otherwise choose an atom}
445             \textcolor{keyword}{const} \textcolor{keywordtype}{int} atomIndex = (int) floor(\hyperlink{utilities_8cpp_a0f9542af4b475ac79cb679d7a8d14db0}{rng} (&\hyperlink{global_8h_a3f4e4ea24d5a5c66feae55d1f329c884}{RNG\_SEED}) * neighborAtoms.size());
446             chosenAtom = neighborAtoms[atomIndex];
447         \textcolor{keywordtype}{int} tot = 0;
448             \textcolor{keywordflow}{while} (tot < atomIndex) \{
449                 tot += nEachType[chosenAtomType];
450                 chosenAtomType++;
451                     \textcolor{keywordflow}{if} (chosenAtomType > sys.\hyperlink{classsim_system_ab5e2e9b6204de15520302fe1d51688dd}{nSpecies}()) \{ \textcolor{comment}{// > not >= because chosenAtomType will
       be decremented next}
452                         \textcolor{keywordflow}{throw} \hyperlink{classcustom_exception}{customException} (\textcolor{stringliteral}{"Error, could not properly identify the type
       of the atom chosen to be moved in aggVolBias"});
453                     \}
454             \}
455             chosenAtomType--;
456             \textcolor{keywordflow}{if} (chosenAtomType < 0) \{ \textcolor{comment}{// in case atomIndex = 0 and above loop did not execute at all}
457                     chosenAtomType = 0;
458             \}
459 
460         N\_in\_j = nEachType[chosenAtomType];
461         V\_in\_j = 4.0/3.0*\hyperlink{global_8h_a598a3330b3c21701223ee0ca14316eca}{PI}*(rc1max\_*rc1max\_*rc1max\_ - rc1min\_*rc1min\_*rc1min\_);
462 
463         \textcolor{comment}{// what to do with chosenAtom?}
464         \textcolor{keywordflow}{if} (\hyperlink{utilities_8cpp_a0f9542af4b475ac79cb679d7a8d14db0}{rng} (&\hyperlink{global_8h_a3f4e4ea24d5a5c66feae55d1f329c884}{RNG\_SEED}) < 0.5) \{
465                     \textcolor{comment}{// move this chosenAtom "out" of pkJ}
466                     \textcolor{keywordtype}{bool} inJ = \textcolor{keyword}{true};
467                     \textcolor{keywordflow}{while} (inJ) \{
468                         \textcolor{keywordflow}{for} (\textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{int} i = 0; i < box.size(); ++i) \{
469                                 tmpNewAtom.\hyperlink{classatom_a3ae5f4880e7831d8b2c9fda72b4eb24a}{pos}[i] = \hyperlink{utilities_8cpp_a0f9542af4b475ac79cb679d7a8d14db0}{rng} (&\hyperlink{global_8h_a3f4e4ea24d5a5c66feae55d1f329c884}{RNG\_SEED}) * box[i];
470                         \}
471 
472                         \textcolor{comment}{// check that this position is "out" of J}
473                         \textcolor{keyword}{const} \textcolor{keywordtype}{double} d2 = \hyperlink{utilities_8cpp_abb1db3a8a3ac46e044bbe7b2c5684c0a}{pbcDist2}(tmpNewAtom.\hyperlink{classatom_a3ae5f4880e7831d8b2c9fda72b4eb24a}{pos}, sys.
      \hyperlink{classsim_system_a90421b19082f7fb8fc23b7264b1161e4}{atoms}[\hyperlink{classmc_move_acb731965547b0326ef318ec96da8b46a}{typeIndex\_}][pkJ].pos, sys.\hyperlink{classsim_system_a8bff9dfb95b1b09a0fab2c1c485ade07}{box}());
474                 \textcolor{keywordflow}{if} (d2 >= rc1max\_*rc1max\_ || d2 < rc1min\_*rc1min\_) \{
475                                 inJ = \textcolor{keyword}{false};
476                         \}
477                     \}
478 
479             \textcolor{comment}{// calculate energy of chosenAtom in current configuration}
480             \textcolor{keywordtype}{double} oldEnergy = 0.0;
481                 \textcolor{keywordflow}{try} \{
482                         oldEnergy = getTempEnergy\_ (sys, box, V, chosenAtomType, chosenAtom);
483                 \} \textcolor{keywordflow}{catch} (\hyperlink{classcustom_exception}{customException} &ce) \{
484                         \textcolor{keywordflow}{throw} \hyperlink{classcustom_exception}{customException} (ce.\hyperlink{classcustom_exception_aeb6ab5848b038adfc68fde86a512f691}{what}());
485                     \}
486 
487                 \textcolor{comment}{// "move" chosenAtomInJ to new location and get energy (amounts to same algorithm as a
       translation)}
488                     std::vector < double > origPos = chosenAtom->\hyperlink{classatom_a3ae5f4880e7831d8b2c9fda72b4eb24a}{pos};
489                     chosenAtom->\hyperlink{classatom_a3ae5f4880e7831d8b2c9fda72b4eb24a}{pos} = tmpNewAtom.\hyperlink{classatom_a3ae5f4880e7831d8b2c9fda72b4eb24a}{pos};
490 
491                     \textcolor{keywordtype}{double} newEnergy = 0.0;
492                     \textcolor{keywordflow}{try} \{
493                         newEnergy = getTempEnergy\_ (sys, box, V, chosenAtomType, chosenAtom);
494                     \} \textcolor{keywordflow}{catch} (\hyperlink{classcustom_exception}{customException} &ce) \{
495                         \textcolor{keywordflow}{throw} \hyperlink{classcustom_exception}{customException} (ce.\hyperlink{classcustom_exception_aeb6ab5848b038adfc68fde86a512f691}{what}());
496                     \}
497 
498                \textcolor{comment}{// restore atom to original position}
499                     chosenAtom->\hyperlink{classatom_a3ae5f4880e7831d8b2c9fda72b4eb24a}{pos} = origPos;
500 
501             \textcolor{comment}{// must know now many chosenAtoms are "out" of J}
502                     N\_out\_j = sys.\hyperlink{classsim_system_a9eea865e6dc1cff377b1e79c4d9c23f0}{numSpecies}[chosenAtomType] - 1; \textcolor{comment}{// -1 to exclude self}
503             \textcolor{keywordtype}{int} totJatoms = sys.\hyperlink{classsim_system_a9eea865e6dc1cff377b1e79c4d9c23f0}{numSpecies}[chosenAtomType];
504 
505                     \textcolor{keywordflow}{if} (sys.\hyperlink{classsim_system_a299fe4372e610b554eaaf5f5957b2dbc}{getCurrentM}() > 0 && sys.
      \hyperlink{classsim_system_a0500a9e84eecfbde7a98cf8a34f719d5}{getFractionalAtomType}() == chosenAtomType) \{
506                             totJatoms++;
507                     \}
508 
509                     \textcolor{keywordflow}{for} (\textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{int} j = 0; j < totJatoms; ++j) \{
510                             \textcolor{keyword}{const} \textcolor{keywordtype}{double} d2 = \hyperlink{utilities_8cpp_abb1db3a8a3ac46e044bbe7b2c5684c0a}{pbcDist2}(sys.\hyperlink{classsim_system_a90421b19082f7fb8fc23b7264b1161e4}{atoms}[chosenAtomType][j].pos, sys.
      \hyperlink{classsim_system_a90421b19082f7fb8fc23b7264b1161e4}{atoms}[\hyperlink{classmc_move_acb731965547b0326ef318ec96da8b46a}{typeIndex\_}][pkJ].pos, sys.\hyperlink{classsim_system_a8bff9dfb95b1b09a0fab2c1c485ade07}{box}());
511                 \textcolor{keywordflow}{if} (d2 < rc1max\_*rc1max\_ && d2 >= rc1min\_*rc1min\_) \{
512                                     \textcolor{keywordflow}{if} (&sys.\hyperlink{classsim_system_a90421b19082f7fb8fc23b7264b1161e4}{atoms}[chosenAtomType][j] != &sys.
      \hyperlink{classsim_system_a90421b19082f7fb8fc23b7264b1161e4}{atoms}[\hyperlink{classmc_move_acb731965547b0326ef318ec96da8b46a}{typeIndex\_}][pkJ]) \{
513                         N\_out\_j--;
514                     \}
515                             \}
516                     \}
517 
518                     \textcolor{comment}{// assign p\_u going from "in J" to "out J"}
519                 dU = newEnergy - oldEnergy;
520             V\_in\_k = 4.0/3.0*\hyperlink{global_8h_a598a3330b3c21701223ee0ca14316eca}{PI}*(rc2max\_*rc2max\_*rc2max\_ - rc2min\_*rc2min\_*rc2min\_);
521             V\_out\_j = V - V\_in\_j - V\_in\_k;
522             p\_u = (pBias\_*V\_out\_j*N\_in\_j*exp(-dU*sys.\hyperlink{classsim_system_a3eeec9678902f8d7fce4dad6064aaf4c}{beta}()))/((1.0 - pBias\_)*V\_in\_j*(N\_out\_j + 1.0));
523         \} \textcolor{keywordflow}{else} \{
524                     \textcolor{comment}{// move this chosenAtom "in" pkK}
525 
526                     \textcolor{comment}{// calculate the energy of its old location}
527                     \textcolor{keywordtype}{double} oldEnergy = 0.0;
528                     \textcolor{keywordflow}{try} \{
529                         oldEnergy = getTempEnergy\_ (sys, box, V, chosenAtomType, chosenAtom);
530                     \} \textcolor{keywordflow}{catch} (\hyperlink{classcustom_exception}{customException} &ce) \{
531                         \textcolor{keywordflow}{throw} \hyperlink{classcustom_exception}{customException} (ce.\hyperlink{classcustom_exception_aeb6ab5848b038adfc68fde86a512f691}{what}());
532                     \}
533 
534                     \textcolor{comment}{// randomly choose a radius from [0, rc2)}
535                     \textcolor{keyword}{const} \textcolor{keywordtype}{double} dr = (rc2max\_ - rc2min\_);
536                 \textcolor{keyword}{const} \textcolor{keywordtype}{double} magnitude = pow((\hyperlink{utilities_8cpp_a0f9542af4b475ac79cb679d7a8d14db0}{rng} (&\hyperlink{global_8h_a3f4e4ea24d5a5c66feae55d1f329c884}{RNG\_SEED})*dr*dr*dr+rc2min\_*rc2min\_*rc2min\_),
       1./3.);
537 
538                     \textcolor{comment}{// then choose a point randomly on the surface of that sphere to place chosenAtom}
539                     std::vector < double > surfaceVec = \hyperlink{utilities_8cpp_af1bc480936b7436d4e679abc5a837815}{random3DSurfaceVector} (
      magnitude), origPos = chosenAtom->\hyperlink{classatom_a3ae5f4880e7831d8b2c9fda72b4eb24a}{pos};
540                     \textcolor{keywordflow}{for} (\textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{int} i = 0; i < origPos.size(); ++i) \{
541                         chosenAtom->\hyperlink{classatom_a3ae5f4880e7831d8b2c9fda72b4eb24a}{pos}[i] = sys.\hyperlink{classsim_system_a90421b19082f7fb8fc23b7264b1161e4}{atoms}[typeIndex2\_][pkK].pos[i] + surfaceVec[i];
542 
543                         \textcolor{comment}{// apply periodic boundary conditions}
544                         \textcolor{keywordflow}{if} (chosenAtom->\hyperlink{classatom_a3ae5f4880e7831d8b2c9fda72b4eb24a}{pos}[i] >= box[i]) \{
545                                 chosenAtom->\hyperlink{classatom_a3ae5f4880e7831d8b2c9fda72b4eb24a}{pos}[i] -= box[i];
546                         \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (chosenAtom->\hyperlink{classatom_a3ae5f4880e7831d8b2c9fda72b4eb24a}{pos}[i] < 0) \{
547                                 chosenAtom->\hyperlink{classatom_a3ae5f4880e7831d8b2c9fda72b4eb24a}{pos}[i] += box[i];
548                         \}
549                     \}
550 
551                     \textcolor{comment}{// store for later}
552                     tmpNewAtom.\hyperlink{classatom_a3ae5f4880e7831d8b2c9fda72b4eb24a}{pos} = chosenAtom->\hyperlink{classatom_a3ae5f4880e7831d8b2c9fda72b4eb24a}{pos};
553 
554                     \textcolor{comment}{// move, recalculate energy}
555                     \textcolor{keywordtype}{double} newEnergy = 0.0;
556                     \textcolor{keywordflow}{try} \{
557                         newEnergy = getTempEnergy\_ (sys, box, V, chosenAtomType, chosenAtom);
558                     \} \textcolor{keywordflow}{catch} (\hyperlink{classcustom_exception}{customException} &ce) \{
559                         \textcolor{keywordflow}{throw} \hyperlink{classcustom_exception}{customException} (ce.\hyperlink{classcustom_exception_aeb6ab5848b038adfc68fde86a512f691}{what}());
560                     \}
561 
562                     \textcolor{comment}{// restore the chosenAtoms position}
563                     chosenAtom->\hyperlink{classatom_a3ae5f4880e7831d8b2c9fda72b4eb24a}{pos} = origPos;
564 
565             \textcolor{comment}{// must know the number of chosenAtoms "in k"}
566             \textcolor{keywordtype}{int} totKatoms = sys.\hyperlink{classsim_system_a9eea865e6dc1cff377b1e79c4d9c23f0}{numSpecies}[chosenAtomType];
567             N\_in\_k = 0;
568             \textcolor{keywordflow}{if} (sys.\hyperlink{classsim_system_a299fe4372e610b554eaaf5f5957b2dbc}{getCurrentM}() > 0 && sys.\hyperlink{classsim_system_a0500a9e84eecfbde7a98cf8a34f719d5}{getFractionalAtomType}() == 
      chosenAtomType) \{
569                             totKatoms++;
570                     \}
571 
572                     \textcolor{keywordflow}{for} (\textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{int} j = 0; j < totKatoms; ++j) \{
573                             \textcolor{keyword}{const} \textcolor{keywordtype}{double} d2 = \hyperlink{utilities_8cpp_abb1db3a8a3ac46e044bbe7b2c5684c0a}{pbcDist2}(sys.\hyperlink{classsim_system_a90421b19082f7fb8fc23b7264b1161e4}{atoms}[chosenAtomType][j].pos, sys.
      \hyperlink{classsim_system_a90421b19082f7fb8fc23b7264b1161e4}{atoms}[typeIndex2\_][pkK].pos, sys.\hyperlink{classsim_system_a8bff9dfb95b1b09a0fab2c1c485ade07}{box}());
574                 \textcolor{keywordflow}{if} (d2 < rc2max\_*rc2max\_ && d2 >= rc2min\_*rc2min\_) \{
575                                     \textcolor{keywordflow}{if} (&sys.\hyperlink{classsim_system_a90421b19082f7fb8fc23b7264b1161e4}{atoms}[chosenAtomType][j] != &sys.
      \hyperlink{classsim_system_a90421b19082f7fb8fc23b7264b1161e4}{atoms}[typeIndex2\_][pkK]) \{ \textcolor{comment}{// pkK and pkJ do not overlap so don't have to check for pkJ}
576                         N\_in\_k++;
577                                 \}
578                 \}
579                     \}
580 
581                     \textcolor{comment}{// assign p\_u going from "in J" to "in K"}
582                     dU = newEnergy - oldEnergy;
583             V\_in\_k = 4.0/3.0*\hyperlink{global_8h_a598a3330b3c21701223ee0ca14316eca}{PI}*(rc2max\_*rc2max\_*rc2max\_ - rc2min\_*rc2min\_*rc2min\_);
584                     p\_u = (pBias\_*V\_in\_k*N\_in\_j*exp(-sys.\hyperlink{classsim_system_a3eeec9678902f8d7fce4dad6064aaf4c}{beta}()*dU))/((1.0 - pBias\_)*V\_in\_j*(N\_in\_k + 1
      .0));
585             \}
586     \}
587 
588         \textcolor{comment}{// biasing}
589         bias = \hyperlink{system_8cpp_acfe185adf03db047fd3753c0d788e0e3}{calculateBias}(sys, sys.\hyperlink{classsim_system_a37dd827f4057049763351510147b9f1d}{getTotN}(), sys.
      \hyperlink{classsim_system_a299fe4372e610b554eaaf5f5957b2dbc}{getCurrentM}()); \textcolor{comment}{// N\_tot doesn't change throughout this move}
590 
591         \textcolor{comment}{// tmmc gets updated the same way, regardless of whether the move gets accepted}
592         \textcolor{keywordflow}{if} (sys.\hyperlink{classsim_system_aa474a50b6353c8897331b1ab1ce53ab1}{useTMMC}) \{
593             sys.\hyperlink{classsim_system_a13173f45a1e40a5f5a3552b0ebe15b54}{tmmcBias}->\hyperlink{classtmmc_ae067afc5b52af203b9d45f18d9737219}{updateC} (sys.\hyperlink{classsim_system_a37dd827f4057049763351510147b9f1d}{getTotN}(), sys.
      \hyperlink{classsim_system_a37dd827f4057049763351510147b9f1d}{getTotN}(), sys.\hyperlink{classsim_system_a299fe4372e610b554eaaf5f5957b2dbc}{getCurrentM}(), sys.\hyperlink{classsim_system_a299fe4372e610b554eaaf5f5957b2dbc}{getCurrentM}(), std::min(1.0, p\_u)); \textcolor{comment}{// since
       the total number of atoms isn't changing, can use getTotN() as both initial and final states}
594     \}
595 
596         \textcolor{keywordflow}{if} (\hyperlink{utilities_8cpp_a0f9542af4b475ac79cb679d7a8d14db0}{rng} (&\hyperlink{global_8h_a3f4e4ea24d5a5c66feae55d1f329c884}{RNG\_SEED}) < p\_u*bias) \{
597             \textcolor{keywordflow}{try} \{
598                     \textcolor{comment}{// atoms were not modified overall so must do that here}
599                     std::vector < double > origPos = chosenAtom->\hyperlink{classatom_a3ae5f4880e7831d8b2c9fda72b4eb24a}{pos};
600                 chosenAtom->\hyperlink{classatom_a3ae5f4880e7831d8b2c9fda72b4eb24a}{pos} = tmpNewAtom.\hyperlink{classatom_a3ae5f4880e7831d8b2c9fda72b4eb24a}{pos}; \textcolor{comment}{// move the atom}
601                     \textcolor{keywordtype}{int} totAtoms = sys.\hyperlink{classsim_system_a9eea865e6dc1cff377b1e79c4d9c23f0}{numSpecies}[chosenAtomType];
602             \textcolor{keywordflow}{if} (sys.\hyperlink{classsim_system_a299fe4372e610b554eaaf5f5957b2dbc}{getCurrentM}() > 0 && sys.\hyperlink{classsim_system_a0500a9e84eecfbde7a98cf8a34f719d5}{getFractionalAtomType}() == 
      chosenAtomType) \{
603                 totAtoms++;
604             \}
605 
606             \textcolor{keywordtype}{int} chosenAtomIndex = -1;
607             \textcolor{keywordflow}{for} (\textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{int} i = 0; i < totAtoms; ++i) \{
608                 \textcolor{keywordflow}{if} (&sys.\hyperlink{classsim_system_a90421b19082f7fb8fc23b7264b1161e4}{atoms}[chosenAtomType][i] == chosenAtom) \{
609                     chosenAtomIndex = i;
610                     \textcolor{keywordflow}{break};
611                 \}
612             \}
613 
614             \textcolor{keywordflow}{if} (chosenAtomIndex < 0) \{
615                 \textcolor{keywordflow}{throw} \hyperlink{classcustom_exception}{customException} (\textcolor{stringliteral}{"Error, could not locate the atom chosen to move in
       aggVolBias move"});
616             \}
617 
618             sys.\hyperlink{classsim_system_a22fdaceea44abd6cd021bac1ecd11890}{translateAtom}(chosenAtomType, chosenAtomIndex, origPos);
619             \} \textcolor{keywordflow}{catch} (\hyperlink{classcustom_exception}{customException} &ce) \{
620                     std::string a = \textcolor{stringliteral}{"Failed to move atom in aggVolBias: "}, b = ce.
      \hyperlink{classcustom_exception_aeb6ab5848b038adfc68fde86a512f691}{what}();
621                     \textcolor{keywordflow}{throw} \hyperlink{classcustom_exception}{customException} (a+b);
622             \}
623             sys.\hyperlink{classsim_system_a6ad31c08955b80873f865b3069618dcb}{incrementEnergy}(dU);
624 
625             \textcolor{comment}{// update Wang-Landau bias, if used}
626             \textcolor{keywordflow}{if} (sys.\hyperlink{classsim_system_aa83b00006b3919fb6e13f1bdeadece6a}{useWALA}) \{
627                     sys.\hyperlink{classsim_system_a7cb5049de8b0988349e89e30e4000407}{getWALABias}()->\hyperlink{classwala_ab439e3f60bea6c54522a870b9ad67acf}{update}(sys.\hyperlink{classsim_system_a37dd827f4057049763351510147b9f1d}{getTotN}(), sys.
      \hyperlink{classsim_system_a299fe4372e610b554eaaf5f5957b2dbc}{getCurrentM}());
628             \}
629 
630             \textcolor{keywordflow}{return} \hyperlink{moves_8h_ae8285cbddc5d21f73f49dcbad82a775a}{MOVE\_SUCCESS};
631         \}
632 
633         \textcolor{comment}{// update Wang-Landau bias (even if moved failed), if used}
634         \textcolor{keywordflow}{if} (sys.\hyperlink{classsim_system_aa83b00006b3919fb6e13f1bdeadece6a}{useWALA}) \{
635             sys.\hyperlink{classsim_system_a7cb5049de8b0988349e89e30e4000407}{getWALABias}()->\hyperlink{classwala_ab439e3f60bea6c54522a870b9ad67acf}{update}(sys.\hyperlink{classsim_system_a37dd827f4057049763351510147b9f1d}{getTotN}(), sys.
      \hyperlink{classsim_system_a299fe4372e610b554eaaf5f5957b2dbc}{getCurrentM}());
636         \}
637 
638         \textcolor{keywordflow}{return} \hyperlink{moves_8h_a9832cf5fcfa8c0894545b591c9908e39}{MOVE\_FAILURE};
639 \}
\end{DoxyCode}


The documentation for this class was generated from the following files\-:\begin{DoxyCompactItemize}
\item 
/home/nam4/\-Desktop/sandbox/\-F\-H\-M\-C\-Simulation/src/\hyperlink{aggvolbias_8h}{aggvolbias.\-h}\item 
/home/nam4/\-Desktop/sandbox/\-F\-H\-M\-C\-Simulation/src/\hyperlink{aggvolbias_8cpp}{aggvolbias.\-cpp}\end{DoxyCompactItemize}
